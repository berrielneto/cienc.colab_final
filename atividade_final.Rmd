---
title: "Atividade Final"
author: "Nilson Berriel"
date: "17/10/2021"
output:
  html_document:
    theme:
      bg: "#121212"
      fg: "#E4E4E4"
      base_font:
        google: "Prompt"
---

A espécie selecionada para esta atividade foi <font color = green>*Senegalia polyphylla* (DC.) Britton & Rose</font>, popularmente conhecida como monjolo, acácia, angico, maricá e muitos outros nomes que irão variar de acordo com sua área de ocorrência no Brasil. [^1] [^2]  É uma árvore pertencente a família Leguminosae, e ao Grupo Ecológico das secundárias iniciais [^3], que pode atingir os 15-20 m de altura e possuir um DAP (Diâmetro à Altura do Peito) de 30-60 cm. [^2] É támbém uma espécie de interesse econômico, pois além do uso madereiro, também está associada a projetos de restauração ambiental, reflorestamentos e arborização urbana. [^2]

Esta é uma espécie decídua, que perde suas folhas nos períodos de seca ou de inverno, não é endemica do Brasil, mas ocorre noa principais dominíos fitogerográficos do país (Amazônia, Caatinga, Cerrado, Mata Atlântica, Pantanal). Sua ocorrencia se dá por muitos países da América Central e Sul, e incluindo o México na América do Norte. [^1] [^4]

![Distribuição da *Senegalia polyphylla*[^1]](C:/R/ciencolab_banco-dados/cienc.colab_final/mapa_ocorrencia_s.polyphylla_brasil.jpg)


[^1]: Terra, V.; Morim, M.P. 2020. Senegalia in **Flora do Brasil 2020**. Jardim Botânico do Rio de Janeiro.Disponível em: <http://reflora.jbrj.gov.br/reflora/floradobrasil/FB101015>. Acesso em: 18 out. 2021
[^2]: Lorenzi, H. 2016. **Árvores brasileiras: manual de identificação e cultivo de plantas arbóreas nativas do Brasil**. Vol. 1. 7ª ed. São Paulo: Instituto Plantarum de Estudos da Flora.
[^3]: Abreu, K. M. P.; Braga, J. M. A.; Nascimento, M. T. 2014. Tree species diversity of coastal lowland semideciduous forest fragments in northern Rio de Janeiro State, Brazil. **Bioscience Journal**, 30(5).
[^4]: Barros, M. J. F.;Morim, M. P. 2014. Senegalia (Leguminosae, Mimosoideae) from the Atlantic Domain, Brazil. **Systematic Botany**, 39(2), 452-477.

A seguir veremos como acessar os dados de distribuição da *Senegalia polyphylla*, a partir dos registros no banco de dados do GBIF.

Começaremos carregando os seguintes pacotes: `tidyverse`, `rgbif` e `magrittr`.

```{r carregando pacotes I, echo=false, warning=FALSE, message=FALSE}
library(tidyverse)
library(rgbif)
library(magrittr)
```

Iremos selecionar os dados utilizaremos a função `occ_data`, do pacote `rgbif`. Neste ponto faremos a aquisição dos dados disponíveis para *Senegalia polyphylla* no banco de dados do GBIF.

```{r Aquisição dos dados}
S.polyphylla_gbif <- occ_data(scientificName = "Senegalia polyphylla", 
                      hasCoordinate = TRUE,
                      hasGeospatialIssue=FALSE)
```

Abaixo iremos identificar as variáveis disponíveis para *S. polyphylla*.
```{r Visualizar variáveis de interesse}
S.polyphylla_gbif$data %>% names
```

Após identificar as variáveis disponíveis, vamos criar uma seleção das variáveis que nos interessam.
```{r selecionando variáveis }
S.polyphylla_gbif1 <- S.polyphylla_gbif$data %>%
  dplyr::select(scientificName, acceptedScientificName, decimalLatitude, decimalLongitude,
                issues,elevation, basisOfRecord, occurrenceStatus, rightsHolder, 
                datasetName, recordedBy, country, locality, stateProvince,county, habitat) 

S.polyphylla_gbif1
```


Utilizandos a função `lapply` podemos checar os níveis das variáveis que tivemos maior interesse.

```{r}
lapply(S.polyphylla_gbif1, unique)

```

A princípio não encontramos níveis suspeitos que possuíssem erros aparentes.



Agora serão carregados novos pacotes para a criação dos mapas. Os pacotes são: `ggmap`, `maps`, `mapdata` e `sf`.

```{r pacotes mapas, warning=FALSE, message=FALSE}
library(ggmap)
library(maps)
library(mapdata)
library(sf)
```

```{r determinando a região}

mapa <- map_data('world',regions = c("Brazil", "Uruguay", "Argentina", "French Guiana", "Suriname", "Colombia", "Venezuela", "Bolivia", "Ecuador", "Chile", "Paraguay", "Peru", "Guyana", "Panama", "Costa Rica", "Nicaragua", "Honduras", "El Salvador", "Belize", "Guatemala", "Mexico", "Trinidad and Tobago", "Caribe", "Puerto Rico", "Dominican Republic", "Haiti", "Jamaica", "Cuba", "Bahamas", "Antiles", "Dominica"))

sf <- st_as_sf (mapa, coords = c("long", "lat"), crs = 4326) %>%
  group_by(region, subregion) %>%
  summarise(geometry = st_combine(geometry)) %>%
  st_cast("POLYGON")  %>%
  group_by(region) %>%
  summarise(geometry = st_combine(geometry)) %>%
  st_cast("MULTIPOLYGON")
```

```{r plotando os pontos}

ggplot( data = sf) + 
  geom_sf( data = sf[ sf$region %in% c("Brazil", "Uruguay", "Argentina", "French Guiana", "Suriname", "Colombia", "Venezuela", "Bolivia", "Ecuador", "Chile", "Paraguay", "Peru", "Guyana", "Panama", "Costa Rica", "Nicaragua", "Honduras", "El Salvador", "Belize", "Guatemala", "Mexico", "Trinidad and Tobago", "Caribe", "Puerto Rico", "Dominican Republic", "Haiti", "Jamaica", "Cuba", "Bahamas", "Antiles", "Dominica"), ], alpha = 0 ) +
  coord_sf() +
  theme_classic() +
  geom_point(data = S.polyphylla_gbif1, aes(x = decimalLongitude, y = decimalLatitude), color = "red") +
  labs(x = "longitude", y = "latitude", title = expression(italic("Senegalia polyphylla")))
```

Podemos filtrar as ocorrências pelos países:

```{r plotando os pontos por países}
ggplot( data = sf) + 
  geom_sf( data = sf[ sf$region %in% c("Brazil", "Uruguay", "Argentina", "French Guiana", "Suriname", "Colombia", "Venezuela", "Bolivia", "Ecuador", "Chile", "Paraguay", "Peru", "Guyana", "Panama", "Costa Rica", "Nicaragua", "Honduras", "El Salvador", "Belize", "Guatemala", "Mexico", "Trinidad and Tobago", "Caribe", "Puerto Rico", "Dominican Republic", "Haiti", "Jamaica", "Cuba", "Bahamas", "Antiles", "Dominica"), ], alpha = 0 ) +
  coord_sf() +
  theme_classic() +
  geom_point(data = S.polyphylla_gbif1, aes(x = decimalLongitude, y = decimalLatitude, color = country)) +
  labs(x = "longitude", y = "latitude", title = expression(italic("Senegalia polyphylla")))
```

```{r}
ggplot( data = sf) + 
  geom_sf( data = sf[ sf$region %in% c("Brazil", "Uruguay", "Argentina", "French Guiana", "Suriname", "Colombia", "Venezuela", "Bolivia", "Ecuador", "Chile", "Paraguay", "Peru", "Guyana", "Panama", "Costa Rica", "Nicaragua", "Honduras", "El Salvador", "Belize", "Guatemala", "Mexico", "Trinidad and Tobago", "Caribe", "Puerto Rico", "Dominican Republic", "Haiti", "Jamaica", "Cuba", "Bahamas", "Antiles", "Dominica"), ], alpha = 0 ) +
  geom_sf( data = sf[ sf$region %in% c("Brazil","Bolivia","Ecuador", "Colombia", "El Salvador", "Mexico"), ], fill = "forestgreen" )+
  coord_sf() +
  theme_classic() +
  geom_point(data = S.polyphylla_gbif1, aes(x = decimalLongitude, y = decimalLatitude, color = country)) +
  labs(x = "longitude", y = "latitude", title = expression(italic("Senegalia polyphylla")))
```

MAPA DAS OCORRÊNCIAS

usando as funções q estão na parte OBIS da atividade

```{r}
library(CoordinateCleaner)
library(obistools)
library(scrubr)
library(biogeo)
```

Para isso utilizamentos a função `flag outlier`, do [prof. Cesar](https://github.com/cammcordeiro/ciencia_colab/blob/main/functions/aux_functions.R).

```{r Função Flag outlier}
source("C:/R/ciencolab_banco-dados/flag_outlier.R")
```

Selecionando as variáveis para aplicarmos a função `flag outlier`.

```{r , results='hide', message=FALSE}
 marcados <- S.polyphylla_gbif$data %>% 
  data.frame() %>% 
  dplyr::select(scientificName, decimalLongitude, decimalLatitude, datasetName) %>% 
  distinct() %>% 
  flag_outlier(., "Senegalia polyphylla (DC.) Britton & Rose")

```

Criando o mapa com a função `flag outlier`.

``` {#r}
ggplot() +
  geom_polygon(data = brasil, aes(x = long, y = lat, group = group)) +
  coord_fixed() +
  theme_classic() +
  geom_point(data = marcados, 
             aes(x = decimalLongitude, y = decimalLatitude, 
                 color = flag)) +
  theme(legend.title = element_blank()) +
  labs(x = "longitude", y = "latitude", 
       title = expression(italic("Metrodorea nigra")))
```

###Leaflet

```{r carregar pacote leaflet}
library(leaflet)
```

```{r}
##############
#talvez não precise usar
#############

# ocorrencias
corvus_gbif <- occ_data(scientificName = "Corvus", 
                      hasCoordinate = TRUE,
                      hasGeospatialIssue = FALSE)
# checar issues
issues_gbif <- corvus_gbif$data$issues %>% 
  unique() %>% 
  strsplit(., "[,]") %>% 
  unlist()

gbif_issues() %>% 
  data.frame() %>% 
  filter(code %in% issues_gbif)
```

```{r}
# selecionar variaveis
corvus <- corvus_gbif$data %>%
  dplyr::select(scientificName, decimalLatitude, decimalLongitude) %>% 
  distinct()

```

Depois de carregar os dados, basta criar um mapa seguindo a sintaxe abaixo. Nela, indicamos um data.frame com dados de coordenadas geográficas em graus decimais. A função addTiles é responsável por indicar o tipo de mapa base utilizado. Aqui vamos utilizar o fundo padrão, mas para mais opções acesse este tutorial. Vamos plotar o mapa e dar uma conferida nas ocorrências.

```{r}
library(leaflet)

# conferir no mapa
corvus %>% 
  leaflet() %>% 
  addTiles() %>% 
  addMarkers(~decimalLongitude,
             ~decimalLatitude)
```

Podemos também dar uma incrementada mudando o tipo de marcador e incluir diferenças de acordo com os níveis de um fator, neste caso datasetName. Também é importante adicionar uma legenda ao mapa para indicar o significado das cores dos marcadores. Novamente, acesse o tutorial indicado para aprender como explorar ainda mais os recursos desta ferramenta. br>

```{r}

pal <- colorFactor(palette = "viridis", domain = unique(corvus$scientificName))

corvus %>% 
  leaflet() %>% 
  addTiles() %>% 
  addCircleMarkers(~decimalLongitude,
                   ~decimalLatitude,
                   radius = 5,
                   label = ~as.character(scientificName),
                   color = ~pal(corvus$scientificName),
                   stroke = FALSE, fillOpacity = 0.5) %>% 
  addLegend('bottomright', 
            colors = unique(pal(corvus$scientificName)), 
            labels = unique(corvus$scientificName),
            title = 'Espécie',
            opacity = 0.5)

```

#Plotly
